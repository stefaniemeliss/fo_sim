###############################################################################
# this script processes all pretest data generated in the ***ARK data collection phase****
###############################################################################

# data from the project stems from multiple sources:
# 1. CONSENT: qualtrics is used to collect consent
# 2. BOOKING: microsoft bookings is used to book a slot
# 3. PSYTOOLKIT: psytoolkit was used to measure individual differences

# outputs generated by the script:
# - fully processed pre-test data
# - master spreadsheet
# - slot allocation spreadsheet

##### --- set up --- #####

# empty work space
rm(list = ls())

# get directories
dir_root <- getwd()
data_collection <- "experiment_ARK"
dir <- file.path(dir_root, data_collection)

# read in files
source(file.path(dir_root, "compute_accuracy.R"))
source(file.path(dir_root, "passwords.R"))
options(xlsx.datetime.format="YYYY/mm/dd hh:mm")
library(dplyr)


#### 1. CONSENT: qualtrics is used to collect consent ####

file_consent <- list.files(path = dir, pattern = "consent_")
consent <- read.csv(file = file.path(dir, file_consent))

# remove first two rows
consent <- consent[grepl("2023", consent$StartDate),]

# remove all participants not consentting
consent <- subset(consent, consent == "I consent to take part in the research project described above")

# remove irrelavant columns
consent <- consent[, c("name", "pseudonym", "consent")]
names(consent)[names(consent) == "name"] <- "ppt_name_signed"
consent$pseudonym <- toupper(consent$pseudonym) # standardise
consent$pseudonym <- gsub("[[:blank:]]", "", consent$pseudonym) # standardise

# remove rows
consent <- subset(consent, pseudonym != "O4N3") # late submission from pilot collection
consent <- consent %>% filter(! pseudonym %in% c("O0U1", "A0N1", "A2O9", "E6S8", "T3Y8")) # completed twice

# overwrite inconsistent pseudonym
consent$pseudonym[consent$pseudonym == "O7R1"] <- "U7R1"
consent$pseudonym[consent$pseudonym == "T9R1" & grepl("P", consent$ppt_name_signed)] <- "T9R2" # two ppt with same pseudonym 

# consent only
file_consent <- list.files(path = dir, pattern = "consent[+]")
tmp <- read.csv(file = file.path(dir, file_consent))

# remove first two rows
tmp <- tmp[grepl("2023", tmp$StartDate),]

# remove all participants not consentting
tmp <- subset(tmp, consent == "I consent to take part in the research project described above")

# remove irrelavant columns
tmp <- tmp[, c("name", "pseudonym", "consent")]
names(tmp)[names(tmp) == "name"] <- "ppt_name_signed"
tmp$pseudonym <- toupper(tmp$pseudonym) # standardise
tmp$pseudonym <- gsub("[[:blank:]]", "", tmp$pseudonym) # standardise

# fix mismatch
tmp$pseudonym[tmp$pseudonym == "A9A1"] <- "A8A1"
tmp$pseudonym[tmp$pseudonym == "T3Y9"] <- "T3Y8"

# combine 
consent <- rbind(consent, tmp)
consent <- unique(consent) # remove duplicates

# CHECK
consent %>% group_by(pseudonym) %>% summarise(n = n()) %>% subset(n > 1)


#### 2. BOOKING: microsoft bookings is used to book a slot ####

file_bookings <- list.files(path = dir, pattern = "Bookings")
bookings <- read.delim(file = file.path(dir, file_bookings))

# get pseudonym
bookings$pseudonym <- gsub("[[:punct:]]", "", bookings$Custom.Fields) # remove all speical characters
bookings$pseudonym <- gsub("  Please enter your personal pseudonym ", "", bookings$pseudonym)
bookings$pseudonym <- toupper(bookings$pseudonym) # standardise
bookings$pseudonym <- gsub("[[:blank:]]", "", bookings$pseudonym) # standardise

# remove all rows that do not contain a pseudonym
bookings <- subset(bookings, Service == "Training slot")

# reduce to relevant columns
bookings <- bookings[, c("pseudonym", "Customer.Name", "Customer.Email", "Customer.Phone", "Date.Time" )]
names(bookings) <- c("pseudonym", "ppt_name", "ppt_email", "ppt_phone", "start_lobby")

# fix mismatch
bookings$pseudonym[bookings$pseudonym == "T9R1" & grepl("P", bookings$ppt_name)] <- "T9R2" # two ppt with same pseudonym 

# make booking a dt object
bookings$start_lobby
bookings$start_lobby <- as.POSIXct(bookings$start_lobby, format = "%d/%m/%Y %H:%M")
bookings$start_lobby
bookings$start_lobby <- as.POSIXct(strptime(bookings$start_lobby, "%Y-%m-%d %H:%M:%S"), tz = "UTC")

#### 3. PSYTOOLKIT: psytoolkit was used to measure individual differences ####

df <- read.csv(file = file.path(dir, "psytoolkit", "data.csv"))

# --- pseudonym ---

df$pseudonym <- toupper(df$pseudonym_1) # standardise
df$pseudonym <- gsub("[[:blank:]]", "", df$pseudonym) # standardise

df <- subset(df, pseudonym != "") # remove all files that do not contain a pseudonym
df <- subset(df, pseudonym != "TEST") # remove all files that do not contain a pseudonym
df <- subset(df, pseudonym != "O7H1") # remove all files that do not contain a pseudonym

# CHECK
df %>% group_by(pseudonym) %>% summarise(n = n()) %>% subset(n > 1)

# fix mismatch
df$pseudonym[df$pseudonym == "17D1"] <- "I7D1"
df$pseudonym[df$pseudonym == "R1E1"] <- "R1R1"
df$pseudonym[df$pseudonym == "A9A1"] <- "A8A1"
df$pseudonym[df$pseudonym == "T3Y9"] <- "T3Y8"

# write raw data (with fixed pseudonym)
tmp <- df
tmp$pseudonym_1 <- tmp$pseudonym
tmp$pseudonym <- NULL

xlsx::write.xlsx(tmp, file.path(dir, "pretest_ARK.xlsx"), sheetName="RAW", col.names=TRUE, row.names=FALSE, append=FALSE, showNA=TRUE)

# delete participants with more than one submission
df <- subset(df, participant != "s.511ee964-e54a-4d7f-b19e-e7a2b6037a7e.txt") # A2M1: 1st attempt at Qs completed incorrectly - to be deleted; use 2nd submission
df <- subset(df, participant != "s.6095ab96-9324-4474-9fcd-69591a202aab.txt") # A0D1: more than 1 submission, delete empty attempt
df <- subset(df, participant != "s.06a3c0ab-c4fc-4eb4-91fb-0d0ea8f78f8a.txt") # E1A1: more than 1 submission, delete incomplete submission
df <- subset(df, participant != "s.6274ba39-9f94-42d5-b65e-5a4a79085838.txt") # O0A3: more than 1 submission, delete incomplete submission
df <- subset(df, participant != "s.d0b15720-06bb-4b93-b6d4-3873043d7d2b.txt") # O0U1: more than 1 submission, delete later attempt

# CHECK
df %>% group_by(pseudonym) %>% summarise(n = n()) %>% subset(n > 1)

# --- demographic data ---

df$age <- df$age

df$gender <- ifelse(df$gender_1 == 1, "male", 
                    ifelse(df$gender_1 == 2, "female",
                           ifelse(df$gender_1 == 3, "different", NA)))

df$ethnicity <- ifelse(df$ethnicity_1 == 1, "Asian", 
                       ifelse(df$ethnicity_1 == 2, "Black",
                              ifelse(df$ethnicity_1 == 3, "Mixed",
                                     ifelse(df$ethnicity_1 == 4, "White",
                                            ifelse(df$ethnicity_1 == 5, "Other", NA)))))

df$education <- ifelse(df$education_1 == 1, "undergraduate", 
                       ifelse(df$education_1 == 2, "postgraduate",
                              ifelse(df$education_1 == 3, "doctorate", NA)))

df$ta_experience <- ifelse(df$ta_experience_1 == 1, TRUE, 
                           ifelse(df$ta_experience_1 == 2, FALSE, NA))


df$school_level <- ifelse(df$school_level_1 == 1, "primary", 
                          ifelse(df$school_level_1 == 2, "secondary",
                                 ifelse(df$school_level_1 == 3, "unknown", NA)))

df$school_ark <- ifelse(df$school_ark_1 == 1, "Ark", 
                        ifelse(df$school_ark_1 == 2, "non-Ark",
                               ifelse(df$school_ark_1 == 3, "unknown", NA)))


# --- compute scales ---

# 1. FEEDBACK ORIENTATION SCALE

df$fo <- rowSums(df[, grepl("fos_", names(df))]) # sum score all items
df$fo_utility <- rowSums(df[, grepl("fos_", names(df))][1:5]) # sum score item 1:5
df$fo_accountability <- rowSums(df[, grepl("fos_", names(df))][6:10]) # sum score item 1:5
df$fo_awareness <- rowSums(df[, grepl("fos_", names(df))][11:15]) # sum score item 1:5
df$fo_efficacy <- rowSums(df[, grepl("fos_", names(df))][16:20]) # sum score item 1:5

# 2. CONSCIENTIOUSNESS (1R, 2R, 3, 4, 5R, 6R, 7, 8, 9, 10R, 11, 12R)

# recode list of items
items <- c("bfi_conscientiousness_1", "bfi_conscientiousness_2", "bfi_conscientiousness_5", 
           "bfi_conscientiousness_6", "bfi_conscientiousness_10", "bfi_conscientiousness_12")
df[items] <- apply(df[items], MARGIN = 2, function(x) 6 - x ) # recoding is done by subtracting the current value from 6, e.g., 6 - 1 = 5 or 6 - 5 = 1
df$conscientiousness <- rowSums(df[, grepl("bfi_conscientiousness_", names(df))]) # sum score all items after re-coding

# 3. ACHIEVEMENT GOAL QUESTIONNAIRE

df$m_app <- df$agq_1 + df$agq_7 + df$agq_3
df$m_av <- df$agq_5 + df$agq_11 + df$agq_9
df$p_app <- df$agq_4 + df$agq_2 + df$agq_8
df$p_av <- df$agq_12 + df$agq_10 + df$agq_6

# 4. DAMMQ

items <- names(df)[grepl("dammq", names(df))]

df$task_persistence <- rowSums(df[, items[1:8]])
df$task_absorption <- rowSums(df[, items[9:12]])
df$preference_challenge <- rowSums(df[, items[13:16]])
df$task_pleasure <- rowSums(df[, items[17:20]])

# 5. n-back task

# overwrite nback file with file path
df[, "nback_1"] <- ifelse(df[, "nback_1"] == "", NA, file.path(dir, "psytoolkit", "experiment_data", df[, "nback_1"]))
# df[df[, "pseudonym"] == "R1R1", "nback_1"] <- NA # delete observation for ppt who reported to have had issues with the nback

# process nback data
tmp <- apply(df[grep("nback_1", names(df))], MARGIN = 1, compute_accuracy) # function defined in separate file
tmp <- do.call(rbind, tmp) # convert list of dataframes to dataframe
tmp <- subset(tmp, !is.na(nback_1)) # remove all rows with NAs

# add to df
df <- merge(df, tmp, by = "nback_1", all.x = T)

nback_cols <- names(df)[grepl("nback|total_|rate_", names(df))] # overrates all counts, rates and file name

# ensure complete data for those ppt that returned to questionnaire using re-routing #

# A0S3: nback missing
df[df$pseudonym == "A0S3", nback_cols] <- 
  df[df$pseudonym == "A0S3" & nchar(df$TIME_end) > 0, nback_cols]
df <- subset(df, participant != "s.a55a8609-7254-4f8e-84a7-45aee5b5baab.txt")

# E0A1: nback data missing
df[df$pseudonym == "E0A1", nback_cols] <- 
  df[df$pseudonym == "E0A1" & nchar(df$TIME_end) > 0, nback_cols]
df <- subset(df, participant != "s.1763bd4f-327a-4634-9dc3-8bda3cbb3bf7.txt")

# O2A1 : asked to do nback again because rate_accuracy was 0
df[df$pseudonym == "O2A1", nback_cols] <- 
  df[df$pseudonym == "O2A1" & df$TIME_start == "2023-08-22-19-00", nback_cols]
df <- subset(df, participant != "s.320acf2a-1419-4fce-bbc6-2aad24ee3854.txt")

# R3N1 : asked to do nback again because rate_accuracy below 0
df[df$pseudonym == "R3N1", nback_cols] <-
  df[df$pseudonym == "R3N1" & df$TIME_start == "2023-08-31-15-23", nback_cols]
df <- subset(df, participant != "s.3e600d41-5d1c-4cda-99a7-77e6dfbc58ab.txt")
df <- subset(df, participant != "s.6efeef2f-0d05-46e7-912b-7bb1ee394660.txt")

# U7N5 : asked to do nback again because rate_accuracy was 0
df[df$pseudonym == "U7N5", nback_cols] <-
  df[df$pseudonym == "U7N5" & df$TIME_start == "2023-08-22-19-48", nback_cols]
df <- subset(df, participant != "s.cd2425fa-b434-4e86-940a-c793d8a8cd18.txt")

# E4H2 : asked to do nback again because rate_accuracy was 0
df[df$pseudonym == "E4H2", nback_cols] <-
  df[df$pseudonym == "E4H2" & df$TIME_start == "2023-08-23-00-07", nback_cols]
df <- subset(df, participant != "s.5571e88c-24bd-4451-b202-c92ae51a388e.txt")

# I2E1 : asked to do feedback orientation again because scale was used backwards
df[df$pseudonym == "I2E1", grepl("fo", names(df))] <-
  df[df$pseudonym == "I2E1" & df$TIME_start == "2023-08-23-09-15", grepl("fo", names(df))]
df <- subset(df, participant != "s.2f01f952-844d-45eb-ad98-f4fbb70dffdd.txt")

# O0U1 : asked to do nback again because rate_accuracy was 0
df[df$pseudonym == "O0U1", nback_cols] <-
  df[df$pseudonym == "O0U1" & df$TIME_start == "2023-08-23-09-59", nback_cols]
df <- subset(df, participant != "s.4daf7214-6e12-4275-b35e-4de9b1be3a0b.txt")

# A2N1 : asked to do nback again because rate_accuracy was 0
df[df$pseudonym == "A2N1", nback_cols] <-
  df[df$pseudonym == "A2N1" & df$TIME_start == "2023-08-23-22-41", nback_cols]
df <- subset(df, participant != "s.897db039-99f5-4465-b68f-795708d618aa.txt")

# I0O3 : asked to do nback again because rate_accuracy was 0
df[df$pseudonym == "I0O3", nback_cols] <-
  df[df$pseudonym == "I0O3" & df$TIME_start == "2023-08-31-16-41", nback_cols]
df <- subset(df, participant != "s.3e98c524-2bbb-4830-a892-de9b3ff06fb4.txt")

# A0N1 : asked to do nback again because rate_accuracy was 0
df[df$pseudonym == "A0N1", nback_cols] <-
  df[df$pseudonym == "A0N1" & df$TIME_start == "2023-09-01-13-34", nback_cols]
df <- subset(df, participant != "s.8309fda2-6df4-434e-a092-9d0598c49f37.txt")
df <- subset(df, participant != "s.3870973c-b8e7-4823-aa46-2123cefad1ed.txt")
df <- subset(df, participant != "s.70e4f635-ca40-4647-8da8-5e1eea136473.txt")

# R1R1 : asked to do nback again because rate_accuracy was 0
df[df$pseudonym == "R1R1", nback_cols] <-
  df[df$pseudonym == "R1R1" & df$TIME_start == "2023-08-30-17-12", nback_cols]
df <- subset(df, participant != "s.2d02cf53-2b4b-465c-bd3d-4c6a813db637.txt")

# O7N9: attempted twice to only do nback but no data is transmitted, hence delete
df <- subset(df, participant != "s.95439e43-cbd0-464a-85d7-ec7fd2d0135f.txt")
df <- subset(df, participant != "s.7d5f8046-d13f-4a86-81f0-3d2ea4e147e4.txt")

# I3A1: attempted questionnaire 6 times # use first attempt for each scale
# Yes I was confused which questionnaire I had to do as there were many on the drop down list. 
# I started from the bottom up and then realised I had to do all. 
# When I started to do the first questionnaire it continued to the next questionnaire which I had already completed but realised I had to do all from beginning to end without leaving the link. 

# first attempt nback accuracy
df[df$pseudonym == "I3A1", nback_cols] <- 
  df[df$pseudonym == "I3A1" & df$TIME_start == "2023-08-14-20-31", nback_cols]
# first attempt DAMMQ
df[df$pseudonym == "I3A1", c("task_persistence", "task_absorption", "preference_challenge", "task_pleasure")] <- 
  df[df$pseudonym == "I3A1" & df$TIME_start == "2023-08-14-20-37", c("task_persistence", "task_absorption", "preference_challenge", "task_pleasure")] 
# first attempt fo & agq
df[df$pseudonym == "I3A1", c(which(names(df)=="fo"), grep("fo_|conscient|m_a|p_a", names(df)))] <- 
  df[df$pseudonym == "I3A1" & df$TIME_start == "2023-08-14-20-40", c(which(names(df)=="fo"), grep("fo_|conscient|m_a|p_a", names(df)))]
# first attempt demogs 
df[df$pseudonym == "I3A1", c("age", "gender", "ethnicity", "education", "ta_experience", "school_level", "school_ark")] <- 
  df[df$pseudonym == "I3A1" & df$TIME_start == "2023-08-14-20-39", c("age", "gender", "ethnicity", "education", "ta_experience", "school_level", "school_ark")]
# mark psytoolkit as complete
tmp <- subset(df, pseudonym == "I3A1")
tmp <- tmp[order(tmp$TIME_start), ]

# keep "s.bd5a08fb-c70c-4859-9f1c-96a46f6d1981.txt"
#df[df$pseudonym == "I3A1" & nchar(df$TIME_end)>0 & df$select_1 == 1, "participant"]
df <- subset(df, participant != "s.2c981997-5b50-4367-81e2-dfec391cb56a.txt")
df <- subset(df, participant != "s.1e1e2638-94f5-4361-aaeb-f2393bc7fad9.txt")
df <- subset(df, participant != "s.3d8b138e-d6f3-4bcb-be09-eeb84d09b5c7.txt")
df <- subset(df, participant != "s.458ea377-ba9b-435e-9ee2-1862cf522c26.txt")
df <- subset(df, participant != "s.81aaf814-0923-4c91-afb0-af966401699d.txt")

# CHECK data
df %>% group_by(pseudonym) %>% summarise(n = n()) %>% subset(n > 1)


# check all newly created columns
start_col <- grep("TIME_total", names(df)) + 1
data <- df[, start_col:ncol(df)]

# write data
xlsx::write.xlsx(data, file.path(dir, "pretest_ARK.xlsx"), sheetName="SCALES", col.names=TRUE, row.names=FALSE, append=TRUE, showNA=TRUE)
xlsx::write.xlsx(df, file.path(dir, "pretest_ARK.xlsx"), sheetName="PROCESSED", col.names=TRUE, row.names=FALSE, append=TRUE, showNA=TRUE)

##### --- extract data --- #####

# --- create master spreadsheet ---

# all.x creates a row for each ppt that had consented to participate
master <- merge(consent, bookings, by = "pseudonym", all = T)

# fix mismatch
# master$ppt_name_signed[grep("768@g", master$ppt_email)] <- NA
# master$pseudonym[grep("768@g", master$ppt_email)] <- paste(master$pseudonym[grep("768@g", master$ppt_email)], " ")

# remove unneccasy cols
master$booking_confirm <- NULL
master$StartDate <- NULL
master$EndDate <- NULL
master$ppt_phone <- ifelse(substr(master$ppt_phone, 1, 1) == 7, paste0("(+44)", master$ppt_phone), paste0(master$ppt_phone)) # add zero to phone number
master$ppt_phone <- ifelse(substr(master$ppt_phone, 1, 2) == 44, paste0("(", master$ppt_phone), paste0(master$ppt_phone)) # add zero to phone number
master$ppt_phone <- gsub("(44", "(+44)", master$ppt_phone, fixed = T)


# read in slot allocation
slots <- read.csv(file.path(dir, "slot_allocation.csv"))
slots <- subset(slots, slots$Start.Lobby != "")
slots$start_lobby <- paste(slots$Date, slots$Start.Lobby)

slots$start_lobby
slots$start_lobby <- as.POSIXct(slots$start_lobby, format = "%d/%m/%Y %H:%M:%S")
slots$start_lobby <- as.POSIXct(strptime(slots$start_lobby, "%Y-%m-%d %H:%M:%S"), tz = "UTC")

slots$start_lobby

slots$start_simulator <- paste(slots$Date, slots$Start.Simulator)
slots$start_simulator <- as.POSIXct(slots$start_simulator, format = "%d/%m/%Y %H:%M:%S")
slots$start_simulator <- as.POSIXct(strptime(slots$start_simulator, "%Y-%m-%d %H:%M:%S"), tz = "UTC")

slots <- slots[, c("start_lobby", "lobby", "start_simulator", "coach")]

# merge slots (DEBUG: tmp) and master
master <- merge(master, slots, by = "start_lobby", all.x = T)

# complete data checks
tmp <- data[, c("pseudonym", "school_ark", "fo", "conscientiousness", "m_app", "task_pleasure", "rate_accuracy")]
names(tmp) <-  c("pseudonym", "complete_demogs", "complete_fo", "complete_bfi", "complete_agq", "complete_dammq", "complete_nback")
complete <- function(x) {
  return(ifelse(is.na(x), F, T))
}
tmp[, 2:7] <- apply(tmp[, 2:7], MARGIN = 2, FUN = complete)

# merge with master
master <- merge(master, tmp, by = "pseudonym", all = T)

# add column that captures "Carlos changed to Jayla writing part"
master$sim_writing <- ifelse(master$start_simulator < as.POSIXct('2023-08-14 09:00'), "Carlos", "Jayla")

# load in old comments if exist
master_cp <- "C:/Users/stefanie.meliss/OneDrive - Ambition Institute/research_projects/Ark Feedback Orientation and Sims/Data/master_spreadsheet_ARK.xlsx"
master_safety <- "C:/Users/stefanie.meliss/OneDrive - Ambition Institute/research_projects/Ark Feedback Orientation and Sims/Data/master_spreadsheet_ARK_safetycopy.xlsx"

if (file.exists(master_cp)) {
  
  # create copy
  file.copy(master_cp, master_safety, overwrite = T)
  
  # read in data from previous sessions
  tmp <- xlsx::read.xlsx(master_cp, sheetName="participant_info")
  

  tmp <- tmp[, c(grep("pseudonym", names(tmp)), grep("chased", names(tmp)), grep("show", names(tmp)), 
                 grep("vids|transcript|comment", names(tmp)))]
  
  # tmp2 <- tmp[tmp$pseudonym == "A2M1", ]
  # tmp3 <- master[master$pseudonym == "A2M1", ]
  # 
  # tmp4 <- merge(tmp3, tmp2, by = c("pseudonym", 
  #                                  "start_simulator"), all.x = T)

  # merge
  master <- merge(master, tmp, by = c("pseudonym"), all = T)
  
} else {
  
  # add additional columns
  master$show <- ""
  master$consent_chased <- ifelse(is.na(master$ppt_name_signed) == T, FALSE, NA)
  master$booking_chased <- ifelse(is.na(master$ppt_name) == T, FALSE, NA)
  master$pretest_chased <- ""
  master$received_vids <- ""
  master$received_transcript <- ""
  master$reviewed_vids <- ""
  master$reviewed_transcript <- ""
  master$coded_vids <- ""
  master$comments_vids <- ""
  master$comments_transcript <- ""
  master$comments_coding <- ""
  master$comments_general <- ""
  master$comments_simulator <- ""
  
}


# re-order columns
master <- master[, c("pseudonym", "start_lobby", "ppt_name_signed", "ppt_name", "ppt_email", "ppt_phone", "start_simulator", "coach", "lobby", 
                     "consent_chased", "booking_chased", "pretest_chased", 
                     "complete_demogs", "complete_fo", "complete_bfi", "complete_agq", "complete_dammq", "complete_nback", 
                     "show", "sim_writing",
                     "received_vids", "received_transcript", "edited_vids",  "reviewed_vids", "reviewed_transcript", "coded_vids", 
                     "comments_vids", "comments_transcript", "comments_coding", "comments_general", "comments_simulator")]

# order sim slots chronologically
master <- master[order(master$start_simulator), ]

# remove duplicates
master <- unique(master)

# CHECK data
master %>% group_by(pseudonym) %>% summarise(n = n()) %>% subset(n > 1)

master <- master[, c("start_lobby", "pseudonym", "ppt_name_signed", "ppt_name", "ppt_email", "ppt_phone", "start_simulator", "coach", "lobby", 
                     "consent_chased", "booking_chased", "pretest_chased", 
                     "complete_demogs", "complete_fo", "complete_bfi", "complete_agq", "complete_dammq", "complete_nback", 
                     "show", "sim_writing",
                     "received_vids", "received_transcript", "edited_vids",  "reviewed_vids", "reviewed_transcript", "coded_vids", 
                     "comments_vids", "comments_transcript", "comments_coding", "comments_general", "comments_simulator")]

# create dictionary
dict <- data.frame(variable = names(master))
dict$explanation <- c(
                      "Scheduled start time of LOBBY session in format YYYY/MM/DD hh:mm",
                      "Participant pseudonym, USE FOR FILE NAMES",
                      "Name (as provided in consent form)",
                      "Name (as provided in bookings form)",
                      "Email (as provided in bookings form)",
                      "Phone number (as provided in bookings form)",
                      "Scheduled start time of simulator session in format YYYY/MM/DD hh:mm",
                      "Assigned staff for coaching",
                      "Assigned staff for lobby",
                      "Data validation: has incomplete data been chased; NA if consent complete",
                      "Data validation: has incomplete data been chased; NA if booking complete",
                      "Data validation: has incomplete data been chased; NA if pretest complete",
                      rep("Data validation for routing as necessary: is pretest element complete", 6),
                      
                      "record of whether session took place",
                      "which puppet contunued writing in simulator",
                      rep("Data validation: has simulator data been received", 2),
                      "Data validation: has video been edited",
                      rep("Data validation/fidelity: has simulator data been reviewed", 2),
                      "Data validation: has video been coded",
                      rep("Data validation/fidelity: comments and notes", 5))
dict$levels_1 <- ""
dict$levels_2 <- ""
dict$levels_3 <- ""
dict$levels_4 <- "" 
dict$levels_5 <- "" 
dict$levels_6 <- "" 

dict$levels_1[dict$variable == "show"] <- "show"
dict$levels_2[dict$variable == "show"] <- "no show"
dict$levels_3[dict$variable == "show"] <- "cancelled"
dict$levels_4[dict$variable == "show"] <- "rebooked"
dict$levels_5[dict$variable == "show"] <- "withdrew"

dict$levels_1[c(grep("received", dict$variable), grep("reviewed", dict$variable), grep("coded", dict$variable), grep("edited", dict$variable))] <- TRUE
dict$levels_2[c(grep("received", dict$variable), grep("reviewed", dict$variable), grep("coded", dict$variable), grep("edited", dict$variable))] <- FALSE
dict$levels_3[c(grep("received", dict$variable), grep("reviewed", dict$variable), grep("coded", dict$variable), grep("edited", dict$variable))] <- NA

xlsx::write.xlsx(master, file.path(dir, "master_spreadsheet_ARK.xlsx"), sheetName="Sheet1", col.names=TRUE, row.names=FALSE, append=FALSE, showNA=TRUE, password=password_master)
xlsx::write.xlsx(master, file.path(dir, "master_spreadsheet_ARK.xlsx"), sheetName="participant_info", col.names=TRUE, row.names=FALSE, append=FALSE, showNA=TRUE)
xlsx::write.xlsx(dict, file.path(dir, "master_spreadsheet_ARK.xlsx"), sheetName="columns_explained", col.names=TRUE, row.names=FALSE, append=TRUE, showNA=TRUE)




##### --- randomisation --- #####

# create separate data frame to randomise
rand <- master[, c("start_simulator", "pseudonym", "ppt_name", "lobby",  "coach")]

# add columns to capture feedback #
sim_cp <- "C:/Users/stefanie.meliss/OneDrive - Ambition Institute/sim_vids/simulator_slots_ARK.xlsx"
sim_safety <- "C:/Users/stefanie.meliss/OneDrive - Ambition Institute/sim_vids/simulator_slots_ARK_safetycopy.xlsx"

if (file.exists(sim_cp)) {
  
  # create copy
  file.copy(sim_cp, sim_safety, overwrite = T)
  
  # read in data from previous sessions
  tmp <- xlsx::read.xlsx(sim_cp, sheetName="Slots")
  tmp <- subset(tmp, nchar(show) > 0)
  # tmp <- tmp[, c(grep("pseudonym", names(tmp)), grep("ppt_name", names(tmp)), grep("start_sim", names(tmp)), grep("treatment_arm", names(tmp)), grep("show", names(tmp)), grep("feedback", names(tmp)), grep("comment", names(tmp)))]
  
  # format slot times
  tmp$start_simulator
  # tmp$start_simulator <- as.POSIXct(tmp$start_simulator, format = "%d/%m/%Y %H:%M")
  tmp$start_simulator <- as.POSIXct(tmp$start_simulator, format = "%Y/%m/%d %H:%M")
  tmp$start_simulator <- as.POSIXct(strptime(tmp$start_simulator, "%Y-%m-%d %H:%M:%S"), tz = "UTC")
  
  # merge
  rand <- merge(rand, tmp, by = c("start_simulator", "pseudonym",	"ppt_name", "lobby", "coach"), all = T)
  
} else {
  
  # My suggestion is anonymous correction should be A, 
  # Sanction/demerit should be B, 
  # Narrate the positive should be C.
  
  rand$show <- ""
  rand$feedback_1_core_a <- ""
  rand$feedback_1_core_b <- ""
  rand$feedback_1_core_c <- ""
  rand$feedback_2_core_a <- ""
  rand$feedback_2_core_b <- ""
  rand$feedback_2_core_c <- ""
  rand$comment <- ""
  
}


# order sim slots chronologically
rand <- rand[order(rand$start_simulator), ]

# omit all rows without a sim slot
rand <- subset(rand, !is.na(start_simulator))

# CHECK data
rand %>% group_by(pseudonym) %>% summarise(n = n()) %>% subset(n > 1)

# remove duplicates
# rand <- rand[!duplicated(rand),]

# read in slot allocation
allocation <- read.delim(file.path(dir, "randomised_group_assignment_n200.txt"), header = F)

if (nrow(rand) > nrow(tmp)) {
  # define start and stop
  idx_start <- nrow(tmp)+1
  idx_stop <- nrow(rand)

  # add allocation for remaining slots
  rand$treatment_arm[idx_start:idx_stop] <- allocation[idx_start:idx_stop, "V1"] # only select the first nrow(master) group assignments and add

}


# DEBUG/TEST
tapply(rand$pseudonym, rand$treatment_arm, length)
sum(tmp$treatment_arm != rand$treatment_arm[1:nrow(tmp)])


# create variable dictionary
dict <- data.frame(variable = names(rand))
dict$explanation <- c("Scheduled start time of simulator session in format YYYY/MM/DD hh:mm",
                      "Participant pseudonym, USE FOR FILE NAMES",
                      "Name of participant, as info for coaches",
                      "assigned lobby staff",
                      "assigned coach",
                      "which condition the participant is in",
                      "record of whether session took place",
                      "coach use only: was core practice A (anonymous correction) shown/which script was used",
                      "coach use only: was core practice B (sanction/demerit) shown/which script was used",
                      "coach use only: was core practice C (narrate the positive) shown/which script was used",
                      "coach use only: was core practice A (anonymous correction) shown/which script was used",
                      "coach use only: was core practice B (sanction/demerit) shown/which script was used",
                      "coach use only: was core practice C (narrate the positive) shown/which script was used",
                      "coach use only: any comments related to session, incl.  problems")
dict$levels_1 <- ""
dict$levels_2 <- ""
dict$levels_3 <- ""
dict$levels_4 <- ""
dict$levels_5 <- "" 
dict$levels_6 <- "" 

dict$levels_1[dict$variable == "show"] <- "show"
dict$levels_2[dict$variable == "show"] <- "no show"
dict$levels_3[dict$variable == "show"] <- "cancelled"
dict$levels_4[dict$variable == "show"] <- "rebooked"
dict$levels_5[dict$variable == "show"] <- "withdrew"

dict$levels_1[grep("feedback", dict$variable)] <- "did"
dict$levels_2[grep("feedback", dict$variable)] <- "did not"
dict$levels_3[grep("feedback", dict$variable)] <- "partial"


# --- save all files --- #


# save file ***PASSWORD PROTECTED****
xlsx::write.xlsx(rand, file.path(dir, "simulator_slots_ARK.xlsx"), sheetName="Sheet1", col.names=TRUE, row.names=FALSE, append=FALSE, showNA=TRUE, password=password_rand)
xlsx::write.xlsx(rand, file.path(dir, "simulator_slots_ARK.xlsx"), sheetName="Slots", col.names=TRUE, row.names=FALSE, append=FALSE, showNA=TRUE)
xlsx::write.xlsx(dict, file.path(dir, "simulator_slots_ARK.xlsx"), sheetName="columns_explained", col.names=TRUE, row.names=FALSE, append=TRUE, showNA=TRUE)



